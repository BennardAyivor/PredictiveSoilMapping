<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Predictive Soil Mapping with R</title>
  <meta name="description" content="Predictive Soil Mapping aims at producing most accurate, most objective, and most usable maps of soil variables by using state-of-the-art Statistical and Machine Learning methods. This books explains how to implement various soil mapping procedures in R.">
  <meta name="generator" content="bookdown 0.7.12 and GitBook 2.6.7">

  <meta property="og:title" content="Predictive Soil Mapping with R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://soilmapper.org" />
  <meta property="og:image" content="http://soilmapper.orgfigures/f0_web.png" />
  <meta property="og:description" content="Predictive Soil Mapping aims at producing most accurate, most objective, and most usable maps of soil variables by using state-of-the-art Statistical and Machine Learning methods. This books explains how to implement various soil mapping procedures in R." />
  <meta name="github-repo" content="envirometrix/PredictiveSoilMapping" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Predictive Soil Mapping with R" />
  <meta name="twitter:site" content="@tom_hengl" />
  <meta name="twitter:description" content="Predictive Soil Mapping aims at producing most accurate, most objective, and most usable maps of soil variables by using state-of-the-art Statistical and Machine Learning methods. This books explains how to implement various soil mapping procedures in R." />
  <meta name="twitter:image" content="http://soilmapper.orgfigures/f0_web.png" />

<meta name="author" content="Tomislav Hengl">


<meta name="date" content="2018-07-04">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="soil-variables-chapter.html">
<link rel="next" href="statistical-theory.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-120633517-1', 'auto');
  ga('send', 'pageview');

</script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Predictive Soil Mapping with R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Predictive Soil Mapping for advanced R users</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#editors"><i class="fa fa-check"></i>Editors</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#connected-publications"><i class="fa fa-check"></i>Connected publications</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#contributions"><i class="fa fa-check"></i>Contributions</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#reproducibility"><i class="fa fa-check"></i>Reproducibility</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Soil resource inventories and soil maps</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#soils-and-soil-inventories"><i class="fa fa-check"></i><b>1.2</b> Soils and soil inventories</a><ul>
<li class="chapter" data-level="1.2.1" data-path="introduction.html"><a href="introduction.html#soil-a-definition"><i class="fa fa-check"></i><b>1.2.1</b> Soil: a definition</a></li>
<li class="chapter" data-level="1.2.2" data-path="introduction.html"><a href="introduction.html#soil-variables"><i class="fa fa-check"></i><b>1.2.2</b> Soil variables</a></li>
<li class="chapter" data-level="1.2.3" data-path="introduction.html"><a href="introduction.html#primary-and-secondary-soil-variables"><i class="fa fa-check"></i><b>1.2.3</b> Primary and secondary soil variables</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#soil-mapping"><i class="fa fa-check"></i><b>1.3</b> Soil mapping</a><ul>
<li class="chapter" data-level="1.3.1" data-path="introduction.html"><a href="introduction.html#what-are-soil-resource-inventories"><i class="fa fa-check"></i><b>1.3.1</b> What are soil resource inventories?</a></li>
<li class="chapter" data-level="1.3.2" data-path="introduction.html"><a href="introduction.html#soil-mapping-approaches-and-concepts"><i class="fa fa-check"></i><b>1.3.2</b> Soil mapping approaches and concepts</a></li>
<li class="chapter" data-level="1.3.3" data-path="introduction.html"><a href="introduction.html#soil-mapping-theory"><i class="fa fa-check"></i><b>1.3.3</b> Theoretical basis of soil mapping: in context of the universal model of spatial variation</a></li>
<li class="chapter" data-level="1.3.4" data-path="introduction.html"><a href="introduction.html#conventional-mapping"><i class="fa fa-check"></i><b>1.3.4</b> Traditional (conventional) soil mapping</a></li>
<li class="chapter" data-level="1.3.5" data-path="introduction.html"><a href="introduction.html#variants-of-soil-maps"><i class="fa fa-check"></i><b>1.3.5</b> Variants of soil maps</a></li>
<li class="chapter" data-level="1.3.6" data-path="introduction.html"><a href="introduction.html#pedometric-mapping"><i class="fa fa-check"></i><b>1.3.6</b> Predictive and Automated soil mapping</a></li>
<li class="chapter" data-level="1.3.7" data-path="introduction.html"><a href="introduction.html#comparison-conventional-pm"><i class="fa fa-check"></i><b>1.3.7</b> Comparison of conventional and pedometric soil mapping</a></li>
<li class="chapter" data-level="1.3.8" data-path="introduction.html"><a href="introduction.html#top-down"><i class="fa fa-check"></i><b>1.3.8</b> Top-down versus bottom-up approaches: subdivision versus agglomeration</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#sources-of-soil-data-for-soil-mapping"><i class="fa fa-check"></i><b>1.4</b> Sources of soil data for soil mapping</a><ul>
<li class="chapter" data-level="1.4.1" data-path="introduction.html"><a href="introduction.html#soil-data-sources-targeted-by-psm"><i class="fa fa-check"></i><b>1.4.1</b> Soil data sources targeted by PSM</a></li>
<li class="chapter" data-level="1.4.2" data-path="introduction.html"><a href="introduction.html#field-observations"><i class="fa fa-check"></i><b>1.4.2</b> Field observations of soil properties</a></li>
<li class="chapter" data-level="1.4.3" data-path="introduction.html"><a href="introduction.html#legacy-soil-profile-data"><i class="fa fa-check"></i><b>1.4.3</b> Legacy soil profile data</a></li>
<li class="chapter" data-level="1.4.4" data-path="introduction.html"><a href="introduction.html#soil-covariates"><i class="fa fa-check"></i><b>1.4.4</b> Soil covariates</a></li>
<li class="chapter" data-level="1.4.5" data-path="introduction.html"><a href="introduction.html#soil-delineations"><i class="fa fa-check"></i><b>1.4.5</b> Soil delineations</a></li>
<li class="chapter" data-level="1.4.6" data-path="introduction.html"><a href="introduction.html#advantages-and-disadvantages-of-using-soil-delineations"><i class="fa fa-check"></i><b>1.4.6</b> Advantages and disadvantages of using soil delineations</a></li>
<li class="chapter" data-level="1.4.7" data-path="introduction.html"><a href="introduction.html#accuracy-of-conventional-soil-polygon-maps"><i class="fa fa-check"></i><b>1.4.7</b> Accuracy of conventional soil polygon maps</a></li>
<li class="chapter" data-level="1.4.8" data-path="introduction.html"><a href="introduction.html#tacit-knowledge"><i class="fa fa-check"></i><b>1.4.8</b> Legacy soil expertise (tacit knowledge)</a></li>
<li class="chapter" data-level="1.4.9" data-path="introduction.html"><a href="introduction.html#pseudo-observations"><i class="fa fa-check"></i><b>1.4.9</b> Pseudo-observations</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#soil-databases"><i class="fa fa-check"></i><b>1.5</b> Soil databases and soil information systems</a><ul>
<li class="chapter" data-level="1.5.1" data-path="introduction.html"><a href="introduction.html#soil-databases"><i class="fa fa-check"></i><b>1.5.1</b> Soil databases</a></li>
<li class="chapter" data-level="1.5.2" data-path="introduction.html"><a href="introduction.html#soil-information-system"><i class="fa fa-check"></i><b>1.5.2</b> Soil Information System</a></li>
<li class="chapter" data-level="1.5.3" data-path="introduction.html"><a href="introduction.html#soil-information-users"><i class="fa fa-check"></i><b>1.5.3</b> Soil information users</a></li>
<li class="chapter" data-level="1.5.4" data-path="introduction.html"><a href="introduction.html#usability-of-soil-geographical-database"><i class="fa fa-check"></i><b>1.5.4</b> Usability of soil geographical database</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="introduction.html"><a href="introduction.html#uncertainty-soil-variables"><i class="fa fa-check"></i><b>1.6</b> Uncertainty of soil variables</a><ul>
<li class="chapter" data-level="1.6.1" data-path="introduction.html"><a href="introduction.html#basic-concepts"><i class="fa fa-check"></i><b>1.6.1</b> Basic concepts</a></li>
<li class="chapter" data-level="1.6.2" data-path="introduction.html"><a href="introduction.html#sources-uncertainty"><i class="fa fa-check"></i><b>1.6.2</b> Sources of uncertainty</a></li>
<li class="chapter" data-level="1.6.3" data-path="introduction.html"><a href="introduction.html#quantifying-the-uncertainty-in-soil-data-products"><i class="fa fa-check"></i><b>1.6.3</b> Quantifying the uncertainty in soil data products</a></li>
<li class="chapter" data-level="1.6.4" data-path="introduction.html"><a href="introduction.html#common-uncertainty-levels-in-soil-maps"><i class="fa fa-check"></i><b>1.6.4</b> Common uncertainty levels in soil maps</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="introduction.html"><a href="introduction.html#summary-and-conclusions"><i class="fa fa-check"></i><b>1.7</b> Summary and conclusions</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="software.html"><a href="software.html"><i class="fa fa-check"></i><b>2</b> Software installation and first steps</a><ul>
<li class="chapter" data-level="2.1" data-path="software.html"><a href="software.html#list-of-software-in-use"><i class="fa fa-check"></i><b>2.1</b> List of software in use</a></li>
<li class="chapter" data-level="2.2" data-path="software.html"><a href="software.html#installing-software-on-ubuntu-os"><i class="fa fa-check"></i><b>2.2</b> Installing software on Ubuntu OS</a></li>
<li class="chapter" data-level="2.3" data-path="software.html"><a href="software.html#Rstudio"><i class="fa fa-check"></i><b>2.3</b> RStudio</a></li>
<li class="chapter" data-level="2.4" data-path="software.html"><a href="software.html#plotkml-and-gsif-packages"><i class="fa fa-check"></i><b>2.4</b> plotKML and GSIF packages</a></li>
<li class="chapter" data-level="2.5" data-path="software.html"><a href="software.html#connecting-r-and-saga-gis"><i class="fa fa-check"></i><b>2.5</b> Connecting R and SAGA GIS</a></li>
<li class="chapter" data-level="2.6" data-path="software.html"><a href="software.html#connecting-r-and-gdal"><i class="fa fa-check"></i><b>2.6</b> Connecting R and GDAL</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html"><i class="fa fa-check"></i><b>3</b> Soil observations and variables</a><ul>
<li class="chapter" data-level="3.1" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#basic-concepts-1"><i class="fa fa-check"></i><b>3.1</b> Basic concepts</a><ul>
<li class="chapter" data-level="3.1.1" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#types-of-soil-observations"><i class="fa fa-check"></i><b>3.1.1</b> Types of soil observations</a></li>
<li class="chapter" data-level="3.1.2" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#soil-properties-of-interest-for-global-soil-mapping"><i class="fa fa-check"></i><b>3.1.2</b> Soil properties of interest for global soil mapping</a></li>
<li class="chapter" data-level="3.1.3" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#reference-methods"><i class="fa fa-check"></i><b>3.1.3</b> Reference methods</a></li>
<li class="chapter" data-level="3.1.4" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#standard-soil-variables-of-interest-for-soil-mapping"><i class="fa fa-check"></i><b>3.1.4</b> Standard soil variables of interest for soil mapping</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#descriptive-soil-profile-observations"><i class="fa fa-check"></i><b>3.2</b> Descriptive soil profile observations</a><ul>
<li class="chapter" data-level="3.2.1" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#depth-to-bedrock"><i class="fa fa-check"></i><b>3.2.1</b> Depth to bedrock</a></li>
<li class="chapter" data-level="3.2.2" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#effective-soil-depth-and-rooting-depth"><i class="fa fa-check"></i><b>3.2.2</b> Effective soil depth and rooting depth</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#chemical-soil-properties"><i class="fa fa-check"></i><b>3.3</b> Chemical soil properties</a><ul>
<li class="chapter" data-level="3.3.1" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#soil-organic-carbon"><i class="fa fa-check"></i><b>3.3.1</b> Soil organic carbon</a></li>
<li class="chapter" data-level="3.3.2" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#soil-ph"><i class="fa fa-check"></i><b>3.3.2</b> Soil pH</a></li>
<li class="chapter" data-level="3.3.3" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#soil-nutrients"><i class="fa fa-check"></i><b>3.3.3</b> Soil nutrients</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#physical-and-hydrological-soil-properties"><i class="fa fa-check"></i><b>3.4</b> Physical and hydrological soil properties</a><ul>
<li class="chapter" data-level="3.4.1" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#coarse-fragments"><i class="fa fa-check"></i><b>3.4.1</b> Coarse fragments</a></li>
<li class="chapter" data-level="3.4.2" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#particle-size-class-distribution-sand-silt-and-clay"><i class="fa fa-check"></i><b>3.4.2</b> Particle size class distribution: sand, silt and clay</a></li>
<li class="chapter" data-level="3.4.3" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#bulk-density"><i class="fa fa-check"></i><b>3.4.3</b> Bulk density</a></li>
<li class="chapter" data-level="3.4.4" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#soil-organic-carbon-stock"><i class="fa fa-check"></i><b>3.4.4</b> Soil organic carbon stock</a></li>
<li class="chapter" data-level="3.4.5" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#available-water-capacity"><i class="fa fa-check"></i><b>3.4.5</b> Available Water Capacity</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#harmonisation-of-soil-data-and-pedo-transfer-functions"><i class="fa fa-check"></i><b>3.5</b> Harmonisation of soil data and pedo-transfer functions</a><ul>
<li class="chapter" data-level="3.5.1" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#basic-concepts-of-harmonisation-of-soil-property-values"><i class="fa fa-check"></i><b>3.5.1</b> Basic concepts of harmonisation of soil property values</a></li>
<li class="chapter" data-level="3.5.2" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#example-of-harmonization-using-texture-by-hand-classes"><i class="fa fa-check"></i><b>3.5.2</b> Example of harmonization using texture-by-hand classes</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#soil-class-data"><i class="fa fa-check"></i><b>3.6</b> Soil class data</a><ul>
<li class="chapter" data-level="3.6.1" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#soil-types"><i class="fa fa-check"></i><b>3.6.1</b> Soil types</a></li>
<li class="chapter" data-level="3.6.2" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#other-factor-type-variables"><i class="fa fa-check"></i><b>3.6.2</b> Other factor-type variables</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#importing-and-formatting-soil-data-in-r"><i class="fa fa-check"></i><b>3.7</b> Importing and formatting soil data in R</a><ul>
<li class="chapter" data-level="3.7.1" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#converting-texture-by-hand-classes-to-fractions"><i class="fa fa-check"></i><b>3.7.1</b> Converting texture-by-hand classes to fractions</a></li>
</ul></li>
<li class="chapter" data-level="3.8" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#converting-munsell-color-codes-to-other-color-systems"><i class="fa fa-check"></i><b>3.8</b> Converting Munsell color codes to other color systems</a></li>
<li class="chapter" data-level="3.9" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#mla-ptfs"><i class="fa fa-check"></i><b>3.9</b> Using Machine Learning to build Pedo-Transfer-Functions</a><ul>
<li class="chapter" data-level="3.9.1" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#ptf-for-bulk-density"><i class="fa fa-check"></i><b>3.9.1</b> PTF for Bulk Density</a></li>
<li class="chapter" data-level="3.9.2" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#ptf-for-correlating-classification-systems"><i class="fa fa-check"></i><b>3.9.2</b> PTF for correlating classification systems</a></li>
</ul></li>
<li class="chapter" data-level="3.10" data-path="soil-variables-chapter.html"><a href="soil-variables-chapter.html#summary-points"><i class="fa fa-check"></i><b>3.10</b> Summary points</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html"><i class="fa fa-check"></i><b>4</b> Preparation of soil covariates for soil mapping</a><ul>
<li class="chapter" data-level="4.1" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#soil-covariate-data-sources"><i class="fa fa-check"></i><b>4.1</b> Soil covariate data sources</a><ul>
<li class="chapter" data-level="4.1.1" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#soil-covs-30m"><i class="fa fa-check"></i><b>4.1.1</b> Soil covariate data sources (30–100 m resolution)</a></li>
<li class="chapter" data-level="4.1.2" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#soil-covs-250m"><i class="fa fa-check"></i><b>4.1.2</b> Soil covariate data sources (250 m resolution or coarser)</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#preparing-soil-covariate-layers"><i class="fa fa-check"></i><b>4.2</b> Preparing soil covariate layers</a><ul>
<li class="chapter" data-level="4.2.1" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#converting-polygon-maps-to-rasters"><i class="fa fa-check"></i><b>4.2.1</b> Converting polygon maps to rasters</a></li>
<li class="chapter" data-level="4.2.2" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#downscaling-upscaling"><i class="fa fa-check"></i><b>4.2.2</b> Downscaling or upscaling (aggregating) rasters</a></li>
<li class="chapter" data-level="4.2.3" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#deriving-dem-parameters-using-saga-gis"><i class="fa fa-check"></i><b>4.2.3</b> Deriving DEM parameters using SAGA GIS</a></li>
<li class="chapter" data-level="4.2.4" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#deriving-dem-parameters-using-litap"><i class="fa fa-check"></i><b>4.2.4</b> Deriving DEM parameters using LITAP</a></li>
<li class="chapter" data-level="4.2.5" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#filtering-out-missing-pixels-and-artifacts"><i class="fa fa-check"></i><b>4.2.5</b> Filtering out missing pixels and artifacts</a></li>
<li class="chapter" data-level="4.2.6" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#overlaying-and-subsetting-raster-stacks-and-points"><i class="fa fa-check"></i><b>4.2.6</b> Overlaying and subsetting raster stacks and points</a></li>
<li class="chapter" data-level="4.2.7" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#working-with-larger-rasters"><i class="fa fa-check"></i><b>4.2.7</b> Working with large(r) rasters</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="soil-covs-chapter.html"><a href="soil-covs-chapter.html#summary-points-1"><i class="fa fa-check"></i><b>4.3</b> Summary points</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="statistical-theory.html"><a href="statistical-theory.html"><i class="fa fa-check"></i><b>5</b> Statistical theory for predictive soil mapping</a><ul>
<li class="chapter" data-level="5.1" data-path="statistical-theory.html"><a href="statistical-theory.html#aspects-variability"><i class="fa fa-check"></i><b>5.1</b> Aspects of spatial variability of soil variables</a><ul>
<li class="chapter" data-level="5.1.1" data-path="statistical-theory.html"><a href="statistical-theory.html#modelling-soil-variability"><i class="fa fa-check"></i><b>5.1.1</b> Modelling soil variability</a></li>
<li class="chapter" data-level="5.1.2" data-path="statistical-theory.html"><a href="statistical-theory.html#umsv"><i class="fa fa-check"></i><b>5.1.2</b> Universal model of soil variation</a></li>
<li class="chapter" data-level="5.1.3" data-path="statistical-theory.html"><a href="statistical-theory.html#soil-depth-models"><i class="fa fa-check"></i><b>5.1.3</b> Modelling the variation of soil with depth</a></li>
<li class="chapter" data-level="5.1.4" data-path="statistical-theory.html"><a href="statistical-theory.html#vertical-aggregation"><i class="fa fa-check"></i><b>5.1.4</b> Vertical aggregation of soil properties</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="statistical-theory.html"><a href="statistical-theory.html#spatial-prediction-of-soil-variables"><i class="fa fa-check"></i><b>5.2</b> Spatial prediction of soil variables</a><ul>
<li class="chapter" data-level="5.2.1" data-path="statistical-theory.html"><a href="statistical-theory.html#main-principles"><i class="fa fa-check"></i><b>5.2.1</b> Main principles</a></li>
<li class="chapter" data-level="5.2.2" data-path="statistical-theory.html"><a href="statistical-theory.html#soil-sampling"><i class="fa fa-check"></i><b>5.2.2</b> Soil sampling</a></li>
<li class="chapter" data-level="5.2.3" data-path="statistical-theory.html"><a href="statistical-theory.html#sec:expertsystems"><i class="fa fa-check"></i><b>5.2.3</b> Knowledge-driven soil mapping</a></li>
<li class="chapter" data-level="5.2.4" data-path="statistical-theory.html"><a href="statistical-theory.html#regression-kriging"><i class="fa fa-check"></i><b>5.2.4</b> Geostatistics-driven soil mapping (pedometric mapping)</a></li>
<li class="chapter" data-level="5.2.5" data-path="statistical-theory.html"><a href="statistical-theory.html#RK-generic"><i class="fa fa-check"></i><b>5.2.5</b> Regression-kriging (generic model)</a></li>
<li class="chapter" data-level="5.2.6" data-path="statistical-theory.html"><a href="statistical-theory.html#spatial-prediction-using-multiple-linear-regression"><i class="fa fa-check"></i><b>5.2.6</b> Spatial Prediction using multiple linear regression</a></li>
<li class="chapter" data-level="5.2.7" data-path="statistical-theory.html"><a href="statistical-theory.html#universal-kriging-prediction-error"><i class="fa fa-check"></i><b>5.2.7</b> Universal kriging prediction error</a></li>
<li class="chapter" data-level="5.2.8" data-path="statistical-theory.html"><a href="statistical-theory.html#regression-kriging-examples"><i class="fa fa-check"></i><b>5.2.8</b> Regression-kriging examples</a></li>
<li class="chapter" data-level="5.2.9" data-path="statistical-theory.html"><a href="statistical-theory.html#regression-kriging-examples-using-the-gsif-package"><i class="fa fa-check"></i><b>5.2.9</b> Regression-kriging examples using the GSIF package</a></li>
<li class="chapter" data-level="5.2.10" data-path="statistical-theory.html"><a href="statistical-theory.html#regression-kriging-and-polygon-averaging"><i class="fa fa-check"></i><b>5.2.10</b> Regression-kriging and polygon averaging</a></li>
<li class="chapter" data-level="5.2.11" data-path="statistical-theory.html"><a href="statistical-theory.html#block-support"><i class="fa fa-check"></i><b>5.2.11</b> Predictions at point vs block support</a></li>
<li class="chapter" data-level="5.2.12" data-path="statistical-theory.html"><a href="statistical-theory.html#gstat-sims"><i class="fa fa-check"></i><b>5.2.12</b> Geostatistical simulations</a></li>
<li class="chapter" data-level="5.2.13" data-path="statistical-theory.html"><a href="statistical-theory.html#automated-mapping"><i class="fa fa-check"></i><b>5.2.13</b> Automated mapping</a></li>
<li class="chapter" data-level="5.2.14" data-path="statistical-theory.html"><a href="statistical-theory.html#selecting-spatial-prediction-models"><i class="fa fa-check"></i><b>5.2.14</b> Selecting spatial prediction models</a></li>
<li class="chapter" data-level="5.2.15" data-path="statistical-theory.html"><a href="statistical-theory.html#regression-kriging-3D"><i class="fa fa-check"></i><b>5.2.15</b> 3D regression-kriging</a></li>
<li class="chapter" data-level="5.2.16" data-path="statistical-theory.html"><a href="statistical-theory.html#multiscale"><i class="fa fa-check"></i><b>5.2.16</b> Predicting with multiscale and multisource data</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="statistical-theory.html"><a href="statistical-theory.html#accuracy-assessment"><i class="fa fa-check"></i><b>5.3</b> Accuracy assessment and the mapping efficiency</a><ul>
<li class="chapter" data-level="5.3.1" data-path="statistical-theory.html"><a href="statistical-theory.html#mapping-accuracy"><i class="fa fa-check"></i><b>5.3.1</b> Mapping accuracy and numeric resolution</a></li>
<li class="chapter" data-level="5.3.2" data-path="statistical-theory.html"><a href="statistical-theory.html#accuracy-assessment-methods"><i class="fa fa-check"></i><b>5.3.2</b> Accuracy assessment methods</a></li>
<li class="chapter" data-level="5.3.3" data-path="statistical-theory.html"><a href="statistical-theory.html#cross-validation-and-its-limitations"><i class="fa fa-check"></i><b>5.3.3</b> Cross-validation and its limitations</a></li>
<li class="chapter" data-level="5.3.4" data-path="statistical-theory.html"><a href="statistical-theory.html#accuracy-of-the-predicted-model-uncertainty"><i class="fa fa-check"></i><b>5.3.4</b> Accuracy of the predicted model uncertainty</a></li>
<li class="chapter" data-level="5.3.5" data-path="statistical-theory.html"><a href="statistical-theory.html#derivation-and-interpretation-of-prediction-interval"><i class="fa fa-check"></i><b>5.3.5</b> Derivation and interpretation of prediction interval</a></li>
<li class="chapter" data-level="5.3.6" data-path="statistical-theory.html"><a href="statistical-theory.html#universal-measures-of-mapping-accuracy"><i class="fa fa-check"></i><b>5.3.6</b> Universal measures of mapping accuracy</a></li>
<li class="chapter" data-level="5.3.7" data-path="statistical-theory.html"><a href="statistical-theory.html#mapping-accuracy-and-soil-survey-costs"><i class="fa fa-check"></i><b>5.3.7</b> Mapping accuracy and soil survey costs</a></li>
<li class="chapter" data-level="5.3.8" data-path="statistical-theory.html"><a href="statistical-theory.html#summary-points-2"><i class="fa fa-check"></i><b>5.3.8</b> Summary points</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html"><i class="fa fa-check"></i><b>6</b> Machine Learning Algorithms for soil mapping</a><ul>
<li class="chapter" data-level="6.1" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#spatial-prediction-of-soil-properties-and-classes-using-mlas"><i class="fa fa-check"></i><b>6.1</b> Spatial prediction of soil properties and classes using MLA’s</a><ul>
<li class="chapter" data-level="6.1.1" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#loading-the-packages-and-data"><i class="fa fa-check"></i><b>6.1.1</b> Loading the packages and data</a></li>
<li class="chapter" data-level="6.1.2" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#spatial-prediction-of-soil-classes-using-mlas"><i class="fa fa-check"></i><b>6.1.2</b> Spatial prediction of soil classes using MLA’s</a></li>
<li class="chapter" data-level="6.1.3" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#modelling-numeric-soil-properties-using-h2o"><i class="fa fa-check"></i><b>6.1.3</b> Modelling numeric soil properties using h2o</a></li>
<li class="chapter" data-level="6.1.4" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#prediction-3D"><i class="fa fa-check"></i><b>6.1.4</b> Spatial prediction of 3D (numeric) variables</a></li>
<li class="chapter" data-level="6.1.5" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#ensemble-predictions-using-h2oensemble"><i class="fa fa-check"></i><b>6.1.5</b> Ensemble predictions using h2oEnsemble</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#a-generic-framework-for-spatial-prediction-using-random-forest"><i class="fa fa-check"></i><b>6.2</b> A generic framework for spatial prediction using Random Forest</a><ul>
<li class="chapter" data-level="6.2.1" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#general-principle-of-rfsp"><i class="fa fa-check"></i><b>6.2.1</b> General principle of RFsp</a></li>
<li class="chapter" data-level="6.2.2" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#geographical-covariates"><i class="fa fa-check"></i><b>6.2.2</b> Geographical covariates</a></li>
<li class="chapter" data-level="6.2.3" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#spatial-prediction-2d-continuous-variable-using-rfsp"><i class="fa fa-check"></i><b>6.2.3</b> Spatial prediction 2D continuous variable using RFsp</a></li>
<li class="chapter" data-level="6.2.4" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#spatial-prediction-2d-variable-with-covariates-using-rfsp"><i class="fa fa-check"></i><b>6.2.4</b> Spatial prediction 2D variable with covariates using RFsp</a></li>
<li class="chapter" data-level="6.2.5" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#spatial-prediction-of-binomial-variable"><i class="fa fa-check"></i><b>6.2.5</b> Spatial prediction of binomial variable</a></li>
<li class="chapter" data-level="6.2.6" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#spatial-prediction-of-soil-types"><i class="fa fa-check"></i><b>6.2.6</b> Spatial prediction of soil types</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="soilmapping-using-mla.html"><a href="soilmapping-using-mla.html#summary-points-3"><i class="fa fa-check"></i><b>6.3</b> Summary points</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="SOC-chapter.html"><a href="SOC-chapter.html"><i class="fa fa-check"></i><b>7</b> Spatial prediction and assessment of Soil Organic Carbon</a><ul>
<li class="chapter" data-level="7.1" data-path="SOC-chapter.html"><a href="SOC-chapter.html#introduction-1"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="SOC-chapter.html"><a href="SOC-chapter.html#measurement-and-derivation-of-soil-organic-carbon"><i class="fa fa-check"></i><b>7.2</b> Measurement and derivation of soil organic carbon</a></li>
<li class="chapter" data-level="7.3" data-path="SOC-chapter.html"><a href="SOC-chapter.html#derivation-of-ocs-and-ocd-using-soil-profile-data"><i class="fa fa-check"></i><b>7.3</b> Derivation of OCS and OCD using soil profile data</a></li>
<li class="chapter" data-level="7.4" data-path="SOC-chapter.html"><a href="SOC-chapter.html#estimation-of-bulk-density-using-a-globally-calibrated-ptf"><i class="fa fa-check"></i><b>7.4</b> Estimation of Bulk Density using a globally-calibrated PTF</a></li>
<li class="chapter" data-level="7.5" data-path="SOC-chapter.html"><a href="SOC-chapter.html#generating-maps-of-ocs"><i class="fa fa-check"></i><b>7.5</b> Generating maps of OCS</a></li>
<li class="chapter" data-level="7.6" data-path="SOC-chapter.html"><a href="SOC-chapter.html#predicting-ocs-from-point-data-the-2d-approach"><i class="fa fa-check"></i><b>7.6</b> Predicting OCS from point data (the 2D approach)</a></li>
<li class="chapter" data-level="7.7" data-path="SOC-chapter.html"><a href="SOC-chapter.html#ocs-3d-approach"><i class="fa fa-check"></i><b>7.7</b> Deriving OCS from soil profile data (the 3D approach)</a></li>
<li class="chapter" data-level="7.8" data-path="SOC-chapter.html"><a href="SOC-chapter.html#deriving-ocs-using-spatiotemporal-models"><i class="fa fa-check"></i><b>7.8</b> Deriving OCS using spatiotemporal models</a></li>
<li class="chapter" data-level="7.9" data-path="SOC-chapter.html"><a href="SOC-chapter.html#summary-points-4"><i class="fa fa-check"></i><b>7.9</b> Summary points</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="http://envirometrix.net/staff">T. (Tom) Hengl</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Predictive Soil Mapping with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="soil-covs-chapter" class="section level1">
<h1><span class="header-section-number">4</span> Preparation of soil covariates for soil mapping</h1>
<p><em>Edited by: T. Hengl</em></p>
<div id="soil-covariate-data-sources" class="section level2">
<h2><span class="header-section-number">4.1</span> Soil covariate data sources</h2>
<div id="soil-covs-30m" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Soil covariate data sources (30–100 m resolution)</h3>
<p>Adding relevant covariates that can explain distribution of soil properties increases accuracy of spatial predictions. Hence prior to generating predictions of soil properties, it is a good idea to invest into preparing a list of Remote Sensing (RS), geomorphological/lithologic and DEM-based covariates that could potentially help explain spatial distribution of soil properties and classes. There are now many high resolution (30–250 m) covariates with global coverage, and that are publicly available without restrictions. Both spatial detail, accessibility and accuracy of RS-based products has been growing exponentially and there is now evidence that that trend is going to slow down in the coming decades <span class="citation">(Herold et al. <a href="references.html#ref-Herold2016">2016</a>)</span>.</p>
<p>The most relevant (global publicly available remote sensing-based covariates that can be downloaded and used to improve predictive soil mapping at high spatial resolutions are, for example:</p>
<ul>
<li><p><a href="https://lta.cr.usgs.gov/SRTM1Arc">SRTM</a> and/or <a href="http://www.eorc.jaxa.jp/ALOS/en/aw3d/index_e.htm">ALOS W3D</a> Digital Elevation Model (DEM) at 30 m and <a href="http://hydro.iis.u-tokyo.ac.jp/~yamadai/MERIT_DEM/">MERIT DEM</a> at 100 m (these can be used to derive some 8–12 DEM derivatives from which some could be crucial for mapping of soil chemical and hydrological properties);</p></li>
<li><p>Landsat 7, 8 satellite images, either available from USGS’s <a href="http://glovis.usgs.gov/">GloVis</a> / <a href="http://earthexplorer.usgs.gov/">EarthExplorer</a>, or from the <a href="https://earthenginepartners.appspot.com/science-2013-global-forest/download_v1.2.html">GlobalForestChange project</a> repository <span class="citation">(Hansen et al. <a href="references.html#ref-hansen2013high">2013</a>)</span>;</p></li>
<li><p><a href="https://global-surface-water.appspot.com/download">Landsat-based Global Surface Water (GSW) dynamics images</a> at 30 m resolution for period 1985–2016 <span class="citation">(Pekel et al. <a href="references.html#ref-pekel2016high">2016</a>)</span>;</p></li>
<li><p>Global Land Cover (GLC) maps based on the <a href="http://www.globallandcover.com">GLC30 project</a> at 30 m resolution for 2000 and 2010 <span class="citation">(Chen et al. <a href="references.html#ref-Chen2014">2015</a>)</span> and similar land cover projects <span class="citation">(Herold et al. <a href="references.html#ref-Herold2016">2016</a>)</span>;</p></li>
<li><p>USGS’s <a href="https://landcover.usgs.gov/glc/">global bare surface images</a> at 30 m resolution;</p></li>
<li><p><a href="http://www.eorc.jaxa.jp/ALOS/en/dataset/dataset_index.htm">JAXA’s ALOS</a> (PALSAR/PALSAR-2) radar images at 20 m resolution <span class="citation">(Shimada et al. <a href="references.html#ref-shimada2014new">2014</a>)</span>; radar images, bands HH: -27.7 (5.3) dB and HV: -35.8 (3.0) dB, from the JAXA’s ALOS project are especially interesting for mapping rock outcrops and exposed bedrock but also to distinguish between bare soil and dense vegation;</p></li>
</ul>
<p>Note that the download time for 30 m global RS data could be significant if the data is needed for a larger area (hence you might consider using some RS data processing hub such as <a href="http://www.sentinel-hub.com/">Sentinel hub</a>, <a href="https://earthengine.google.com/">Google Earth Engine</a> and/or <a href="https://aws.amazon.com/public-datasets/">Amazon Web Services</a> instead of trying to download large mosaics yourself).</p>
</div>
<div id="soil-covs-250m" class="section level3">
<h3><span class="header-section-number">4.1.2</span> Soil covariate data sources (250 m resolution or coarser)</h3>
<p><span class="citation">Hengl, Mendes de Jesus, et al. (<a href="references.html#ref-Hengl2017SoilGrids250m">2017</a>)</span> used a large stack of coarser resolution covariate layers for producing SoilGrids250m predictions, most of which were based on remote sensing data:</p>
<ul>
<li><p>DEM-derived surfaces — slope, profile curvature, Multiresolution Index of Valley Bottom Flatness (VBF), deviation from Mean Value, valley depth, negative and positive Topographic Openness and SAGA Wetness Index — all based on the global merge of SRTMGL3 DEM and GMTED2010 <span class="citation">(Danielson and Gesch <a href="references.html#ref-Danielson2011GMTED">2011</a>)</span>. All DEM derivatives were computed using SAGA GIS <span class="citation">(Conrad et al. <a href="references.html#ref-gmd-8-1991-2015">2015</a>)</span>,</p></li>
<li><p>Long-term averaged monthly mean and standard deviation of the MODIS Enhanced Vegetation Index (EVI). Derived using a stack of MOD13Q1 EVI images <span class="citation">(Savtchenko et al. <a href="references.html#ref-Savtchenko2004ASR">2004</a>)</span>,</p></li>
<li><p>Long-term averaged mean monthly surface reflectances for MODIS bands 4 (NIR) and 7 (MIR). Derived using a stack of MCD43A4 images <span class="citation">(Mira et al. <a href="references.html#ref-mira2015modis">2015</a>)</span>,</p></li>
<li><p>Long-term averaged monthly mean and standard deviation of the MODIS land surface temperature (daytime and nighttime). Derived using a stack of MOD11A2 LST images <span class="citation">(Wan <a href="references.html#ref-wan2006modis">2006</a>)</span>,</p></li>
<li><p>Long-term averaged mean monthly hours under snow cover based on a stack of MOD10A2 8-day snow occurrence images <span class="citation">(Hall and Riggs <a href="references.html#ref-hall2007accuracy">2007</a>)</span>,</p></li>
<li><p>Land cover classes (cultivated land, forests, grasslands, shrublands, wetlands, tundra, artificial surfaces and bareland cover) for the year 2010 based on the GlobCover30 product by the National Geomatics Center of China <span class="citation">(Chen et al. <a href="references.html#ref-Chen2014">2015</a>)</span>. Upscaled to resolution and expressed in percent of pixel coverage,</p></li>
<li><p>Monthly precipitation images derived as the weighted average between the WorldClim monthly precipitation <span class="citation">(Hijmans et al. <a href="references.html#ref-Hijmans2005IJC">2005</a>)</span> and GPCP Version 2.2 <span class="citation">(Huffman and Bolvin <a href="references.html#ref-huffman2009gpcp">2009</a>)</span>,</p></li>
<li><p>Long-term averaged mean monthly hours under snow cover. Derived using a stack of MOD10A2 8-day snow occurrence images,</p></li>
<li><p>Lithologic units (acid plutonics, acid volcanic, basic plutonics, basic volcanics, carbonate sedimentary rocks, evaporite, ice and glaciers, intermediate plutonics, intermediate volcanics, metamorphics, mixed sedimentary rocks, pyroclastics, siliciclastic sedimentary rocks, unconsolidated sediment) based on Global Lithological Map GLiM <span class="citation">(Hartmann and Moosdorf <a href="references.html#ref-GGGE:GGGE2352">2012</a>)</span>,</p></li>
<li><p>Landform classes (breaks/foothills, flat plains, high mountains/deep canyons, hills, low hills, low mountains, smooth plains) based on the USGS’s Map of Global Ecological Land Units <span class="citation">(Sayre et al. <a href="references.html#ref-sayre2014new">2014</a>)</span>.</p></li>
<li><p>Global Water Table Depth in meters <span class="citation">(Fan, Li, and Miguez-Macho <a href="references.html#ref-fan2013global">2013</a>)</span>,</p></li>
<li><p>Landsat-based estimated distribution of Mangroves <span class="citation">(Giri et al. <a href="references.html#ref-giri2011status">2011</a>)</span>,</p></li>
<li><p>Average soil and sedimentary-deposit thickness in meters <span class="citation">(Pelletier et al. <a href="references.html#ref-Pelletier2016">2016</a>)</span>.</p></li>
</ul>
<p>These covariates were selected to represent factors of soil formation according to <span class="citation">Jenny (<a href="references.html#ref-jenny1994factors">1994</a>)</span>: climate, relief, living organisms, water dynamics and parent material. Out of the five main factors, water dynamics and living organisms (especially vegetation dynamics) are not trivial to represent as these operate over long periods of time and often exhibit chaotic behaviour. Using reflectance bands such as the mid-infrared MODIS bands from a single day, would have little use to soil mapping for areas with dynamic vegetation, i.e. with strong seasonal changes in vegetation cover. To account for seasonal fluctuation and for inter-annual variations in surface reflectance, long-term temporal signatures of the soil surface derived as monthly averages from long-term MODIS imagery (15 years of data) can be used <span class="citation">(Hengl, Mendes de Jesus, et al. <a href="references.html#ref-Hengl2017SoilGrids250m">2017</a>)</span>. Long-term average seasonal signatures of surface reflectance or vegetation index provide a better indication of soil characteristics than only a single snapshot of surface reflectance. Computing temporal signatures of the land surface requires a considerable investment of time (comparable to the generation of climatic images vs temporary weather maps), but it is possibly the only way to represent the cumulative influence of living organisms on soil formation.</p>
<p><span class="citation">Behrens et al. (<a href="references.html#ref-Behrens2018128">2018</a>)</span> have recently discovered that, for example, DEM derivatives correlate derived at coarser scales correlate more with some targeted soil properties than the derivatives derived as fine scales; in this case, scale was represented through various DEM aggregation levels and filter sizes. Some physical and chemical processes of soil formation or vegetation distribution might not be visible at finer aggregation levels, but then become very visible at coarser aggregation levels. In fact, it seems that spatial dependencies and interactions of the covariates can be explained simply by aggregating DEM and the derivatives.</p>
</div>
</div>
<div id="preparing-soil-covariate-layers" class="section level2">
<h2><span class="header-section-number">4.2</span> Preparing soil covariate layers</h2>
<p>Before we are able to fit spatial prediction models and generate soil maps, a significant amount of time is also spent on preparing covariate “layers” that can be used as independent variables (i.e. “predictor variables”) in the statistical modelling. Typical operations used to generate soil covariate layers include:</p>
<ul>
<li><p>Converting polygon maps to rasters,</p></li>
<li><p>Downscaling or upscaling (aggregating) rasters to match the target resolution (i.e. preparing a <em>stack</em>),</p></li>
<li><p>Filtering out missing pixels / reducing noise and multicolinearity (data overlap) problems,</p></li>
<li><p>Overlaying and subsetting raster stacks and points,</p></li>
</ul>
<p>The following examples should give you some ideas about how to program those steps using the shortest possible syntax running the fastest and most robust algorithms. Raster data can often be very large (e.g. millions of pixels) so processing large stacks of remote sensing scenes in R needs to be planned carefully. The complete R tutorial you can download from the <strong><a href="https://github.com/envirometrix/PredictiveSoilMapping">github repository</a></strong>. Instructions on how to install and set-up all software used in this example you can find in the software installation chapter <a href="software.html#software">2</a>.</p>
<div id="converting-polygon-maps-to-rasters" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Converting polygon maps to rasters</h3>
<p>Before we can attach a polygon map to other stacks of covariates, this needs to be rasterized i.e. converted to a raster layer defined with its bounding box (extent) and spatial resolution. Consider for example the <a href="http://plotkml.r-forge.r-project.org/eberg.html">Ebergötzen data set</a> polygon map from the plotKML package (Fig. <a href="soil-covs-chapter.html#fig:eberg-zones-spplot">4.1</a>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rgdal)
<span class="kw">library</span>(raster)
<span class="kw">library</span>(plotKML)
<span class="kw">data</span>(eberg_zones)
<span class="kw">spplot</span>(eberg_zones[<span class="dv">1</span>])</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:eberg-zones-spplot"></span>
<img src="Soil_covariates_files/figure-html/eberg-zones-spplot-1.png" alt="Ebergotzen parent material polygon map with legend." width="70%" />
<p class="caption">
Figure 4.1: Ebergotzen parent material polygon map with legend.
</p>
</div>
<p>We can convert this object to a raster by using the <a href="https://cran.r-project.org/web/packages/raster/">raster package</a>. Note that before we can run the operation, we need to know the target grid system i.e. extent of the grid and spatial resolution. We can use this from an existing layer:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(plotKML)
<span class="kw">data</span>(<span class="st">&quot;eberg_grid25&quot;</span>)
<span class="kw">gridded</span>(eberg_grid25) &lt;-<span class="st"> </span><span class="er">~</span>x<span class="op">+</span>y
<span class="kw">proj4string</span>(eberg_grid25) &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:31467&quot;</span>)
r &lt;-<span class="st"> </span><span class="kw">raster</span>(eberg_grid25)
r
<span class="co">#&gt; class       : RasterLayer </span>
<span class="co">#&gt; dimensions  : 400, 400, 160000  (nrow, ncol, ncell)</span>
<span class="co">#&gt; resolution  : 25, 25  (x, y)</span>
<span class="co">#&gt; extent      : 3570000, 3580000, 5708000, 5718000  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +init=epsg:31467 +proj=tmerc +lat_0=0 +lon_0=9 +k=1 +x_0=3500000 +y_0=0 +datum=potsdam +units=m +no_defs +ellps=bessel +towgs84=598.1,73.7,418.2,0.202,0.045,-2.455,6.7 </span>
<span class="co">#&gt; data source : in memory</span>
<span class="co">#&gt; names       : DEMTOPx </span>
<span class="co">#&gt; values      : 159, 428  (min, max)</span></code></pre></div>
<p>The <code>eberg_grids25</code> object is a <code>SpatialPixelsDataFrame</code>, which is a spatial gridded data structure of the <a href="https://cran.r-project.org/web/packages/sp/">sp package</a> package. The raster package also offers data structures for spatial (gridded) data, and stores such data as <code>RasterLayer</code> class. Gridded data can be converted from class <code>SpatialPixelsDataFrame</code> to Raster layer with the <a href="http://www.rdocumentation.org/packages/raster/functions/raster"><code>raster</code></a> command. The <a href="http://www.inside-r.org/packages/cran/sp/docs/CRS"><code>CRS</code></a> command of the sp package can be used to set a spatial projection. <a href="http://spatialreference.org/ref/epsg/31467/">EPSG projection 31467</a> is the German coordinate system (each coordinate system has an associated EPSG number that can be obtained from <a href="http://spatialreference.org/" class="uri">http://spatialreference.org/</a>.</p>
<p>Conversion from polygon to raster is now possible via the <a href="http://www.rdocumentation.org/packages/raster/functions/rasterize"><code>rasterize</code></a> command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(eberg_zones)
<span class="co">#&gt; [1] &quot;ZONES&quot;</span>
eberg_zones_r &lt;-<span class="st"> </span><span class="kw">rasterize</span>(eberg_zones, r, <span class="dt">field=</span><span class="st">&quot;ZONES&quot;</span>)
<span class="kw">plot</span>(eberg_zones_r)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:eberg-zones-grid"></span>
<img src="Soil_covariates_files/figure-html/eberg-zones-grid-1.png" alt="Ebergotzen parent material polygon map rasterized." width="70%" />
<p class="caption">
Figure 4.2: Ebergotzen parent material polygon map rasterized.
</p>
</div>
<p>Converting large polygons in R using the raster package could be very time-consuming, hence often a more efficient approach is to use SAGA GIS which can handle large data and is easy to run in parallel. First, you need to export the polygon map to shapefile format that can be done with commands of the <a href="https://cran.r-project.org/web/packages/rgdal/">rgdal package</a> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">eberg_zones<span class="op">$</span>ZONES_int &lt;-<span class="st"> </span><span class="kw">as.integer</span>(eberg_zones<span class="op">$</span>ZONES)
<span class="kw">writeOGR</span>(eberg_zones[<span class="st">&quot;ZONES_int&quot;</span>], <span class="st">&quot;extdata/eberg_zones.shp&quot;</span>, <span class="st">&quot;.&quot;</span>, <span class="st">&quot;ESRI Shapefile&quot;</span>)</code></pre></div>
<p>The <code>writeOGR()</code> command writes a SpatialPolygonsDataFrame (the data structure for polygon data in R) to an ESRI shapefile. Here we only writing the attribute <code>&quot;ZONES_int&quot;</code> to the shapefile. It is, however, also possible to write all attributes of the SpatialPolygonsDataFrame to a shapefile.</p>
<p>Next, you can locate the (previously installed) SAGA GIS command line program (on Microsoft Windows OS or Linux system):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span>(.Platform<span class="op">$</span>OS.type<span class="op">==</span><span class="st">&quot;unix&quot;</span>){
  saga_cmd =<span class="st"> &quot;saga_cmd&quot;</span>
}
<span class="cf">if</span>(.Platform<span class="op">$</span>OS.type<span class="op">==</span><span class="st">&quot;windows&quot;</span>){
  saga_cmd =<span class="st"> &quot;C:/Progra~1/SAGA-GIS/saga_cmd.exe&quot;</span>
}
saga_cmd
<span class="co">#&gt; [1] &quot;saga_cmd&quot;</span></code></pre></div>
<p>and finally use the module <a href="http://saga-gis.org/saga_module_doc/2.2.7/grid_gridding_0.html">‘’grid_gridding’’</a> to convert the shapefile to a grid:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pix =<span class="st"> </span><span class="dv">25</span>
<span class="kw">system</span>(<span class="kw">paste0</span>(saga_cmd, <span class="st">&#39; grid_gridding 0 -INPUT </span><span class="ch">\&quot;</span><span class="st">extdata/eberg_zones.shp</span><span class="ch">\&quot;</span><span class="st"> &#39;</span>,
      <span class="st">&#39;-FIELD </span><span class="ch">\&quot;</span><span class="st">ZONES_int</span><span class="ch">\&quot;</span><span class="st"> -GRID </span><span class="ch">\&quot;</span><span class="st">extdata/eberg_zones.sgrd</span><span class="ch">\&quot;</span><span class="st"> -GRID_TYPE 0 &#39;</span>,
      <span class="st">&#39;-TARGET_DEFINITION 0 -TARGET_USER_SIZE &#39;</span>, pix, <span class="st">&#39; -TARGET_USER_XMIN &#39;</span>, 
      <span class="kw">extent</span>(r)[<span class="dv">1</span>]<span class="op">+</span>pix<span class="op">/</span><span class="dv">2</span>,<span class="st">&#39; -TARGET_USER_XMAX &#39;</span>, <span class="kw">extent</span>(r)[<span class="dv">2</span>]<span class="op">-</span>pix<span class="op">/</span><span class="dv">2</span>, 
      <span class="st">&#39; -TARGET_USER_YMIN &#39;</span>, <span class="kw">extent</span>(r)[<span class="dv">3</span>]<span class="op">+</span>pix<span class="op">/</span><span class="dv">2</span>,<span class="st">&#39; -TARGET_USER_YMAX &#39;</span>, 
      <span class="kw">extent</span>(r)[<span class="dv">4</span>]<span class="op">-</span>pix<span class="op">/</span><span class="dv">2</span>))
eberg_zones_r2 &lt;-<span class="st"> </span><span class="kw">readGDAL</span>(<span class="st">&quot;extdata/eberg_zones.sdat&quot;</span>)
<span class="co">#&gt; extdata/eberg_zones.sdat has GDAL driver SAGA </span>
<span class="co">#&gt; and has 400 rows and 400 columns</span></code></pre></div>
<p>With the <code>system()</code> command we can invoke an operating system (OS) command, here we use it to run the <code>saga_cmd.exe</code> file from R. The paste0 function is used to paste together a string that is passed to the <code>system()</code> command. The string starts with the OS command we would like to invoke (here <code>saga_cmd.exe</code>) followed by input required for the running the OS command.</p>
<p>Note that the bounding box (in SAGA GIS) needs to be defined using the center of the corner pixel and not the corners, hence we take half of the pixel size for extent coordinates from raster package. Also note that the class names have been lost during rasterization (we work with integers in SAGA GIS), but we can attach them back by using e.g.:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">levels</span>(eberg_zones<span class="op">$</span>ZONES)
<span class="co">#&gt; [1] &quot;Clay_and_loess&quot;  &quot;Clayey_derivats&quot; &quot;Sandy_material&quot;  &quot;Silt_and_sand&quot;</span>
eberg_zones_r2<span class="op">$</span>ZONES &lt;-<span class="st"> </span><span class="kw">as.factor</span>(eberg_zones_r2<span class="op">$</span>band1)
<span class="kw">levels</span>(eberg_zones_r2<span class="op">$</span>ZONES) &lt;-<span class="st"> </span><span class="kw">levels</span>(eberg_zones<span class="op">$</span>ZONES)
<span class="kw">summary</span>(eberg_zones_r2<span class="op">$</span>ZONES)
<span class="co">#&gt;  Clay_and_loess Clayey_derivats  Sandy_material   Silt_and_sand </span>
<span class="co">#&gt;           28667           35992           21971           73370</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:eberg-zones-rasterized"></span>
<img src="figures/eberg_zones_rasterized.png" alt="Eberg zones rasterized to 25 m resolution." width="70%" />
<p class="caption">
Figure 4.3: Eberg zones rasterized to 25 m resolution.
</p>
</div>
</div>
<div id="downscaling-upscaling" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Downscaling or upscaling (aggregating) rasters</h3>
<p>In order for all covariates to perfectly <em>stack</em>, we also need to adjust resolution of some covariates that have either too coarse or too fine resolution than the target resolution. Process of bringing raster layers to target grid is also known as <strong>resampling</strong>. Consider the following example from the Ebergotzen case study:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(eberg_grid)
<span class="kw">gridded</span>(eberg_grid) &lt;-<span class="st"> </span><span class="er">~</span>x<span class="op">+</span>y
<span class="kw">proj4string</span>(eberg_grid) &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:31467&quot;</span>)
<span class="kw">names</span>(eberg_grid)
<span class="co">#&gt; [1] &quot;PRMGEO6&quot; &quot;DEMSRT6&quot; &quot;TWISRT6&quot; &quot;TIRAST6&quot; &quot;LNCCOR6&quot;</span></code></pre></div>
<p>In this case we have few layers that we would like to use for spatial prediction in combination with the maps produced in the previous sections, but their resolution is 100 m i.e. about 16 times coarser. Probably the most robust way to resample rasters is to use the <a href="http://www.gdal.org/gdalwarp.html"><code>gdalwarp</code></a> function from the GDAL software. Assuming that you have already installed GDAL, you only need to locate the program on your system, and then you can again run <a href="http://www.gdal.org/gdalwarp.html"><code>gdalwarp</code></a> via the system command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">writeGDAL</span>(eberg_grid[<span class="st">&quot;TWISRT6&quot;</span>], <span class="st">&quot;extdata/eberg_grid_TWISRT6.tif&quot;</span>)
<span class="kw">system</span>(<span class="kw">paste0</span>(<span class="st">&#39;gdalwarp extdata/eberg_grid_TWISRT6.tif&#39;</span>,
              <span class="st">&#39; extdata/eberg_grid_TWISRT6_25m.tif -r </span><span class="ch">\&quot;</span><span class="st">cubicspline</span><span class="ch">\&quot;</span><span class="st"> -te &#39;</span>, 
              <span class="kw">paste</span>(<span class="kw">as.vector</span>(<span class="kw">extent</span>(r))[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">4</span>)], <span class="dt">collapse=</span><span class="st">&quot; &quot;</span>),
              <span class="st">&#39; -tr &#39;</span>, pix, <span class="st">&#39; &#39;</span>, pix, <span class="st">&#39; -overwrite&#39;</span>))</code></pre></div>
<p>The writeGDAL commands writes the TWISRT6 grid, that is stored in the eberg_grid grid stack, to a TIFF file. This TIFF is subsequently read by the gdalwarp function and resampled to a 25m TIFF file using <code>cubicspline</code>, which will fill in values between original grid using smooth surfaces. Note that the paste0 function in the <code>system()</code> command pastes together the following string:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="st">&quot;C:/Progra~1/GDAL/gdalwarp.exe eberg_grid_TWISRT6.tif </span>
<span class="st">eberg_grid_TWISRT6_25m.tif -r </span><span class="dt">\&quot;</span><span class="st">cubicspline</span><span class="dt">\&quot;</span><span class="st"> </span>
<span class="st">-te 3570000 5708000 3580000 5718000 -tr 25 25 -overwrite&quot;</span></code></pre></div>
<p>We can compare the two maps (the original and the downscaled) next to each other by using:</p>
<div class="figure" style="text-align: center"><span id="fig:eberg-original-vs-downscaled"></span>
<img src="figures/eberg_original_vs_downscaled.png" alt="Original TWI vs downscaled map from 100 m to 25 m." width="100%" />
<p class="caption">
Figure 4.4: Original TWI vs downscaled map from 100 m to 25 m.
</p>
</div>
<p>The map on the right looks much smoother of course (assuming that this variable varies continuously in space, this could very well be an accurate picture), but it is important to realize that downscaling can only be implemented up to certain target resolution i.e. only for certain features. For example, downscaling TWI from 100 to 25 m is not much of problem, but to go beyond 10 m would probably result in large differences from a TWI calculated at 10 m resolution (in other words: be careful with downscaling because it is often not trivial).</p>
<p>The opposite process from downscaling is upscaling or aggregation. Although this one can also potentially be tricky, it is much more straight process than downscaling. We recommend using the <code>average</code> method in GDAL for aggregating values e.g.:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system</span>(<span class="kw">paste0</span>(<span class="st">&#39;gdalwarp extdata/eberg_grid_TWISRT6.tif&#39;</span>,
              <span class="st">&#39; extdata/eberg_grid_TWISRT6_250m.tif -r </span><span class="ch">\&quot;</span><span class="st">average</span><span class="ch">\&quot;</span><span class="st"> -te &#39;</span>, 
              <span class="kw">paste</span>(<span class="kw">as.vector</span>(<span class="kw">extent</span>(r))[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">4</span>)], <span class="dt">collapse=</span><span class="st">&quot; &quot;</span>),
              <span class="st">&#39; -tr 250 250 -overwrite&#39;</span>))</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:eberg-original-vs-aggregated"></span>
<img src="figures/eberg_original_vs_aggregated.png" alt="Original TWI vs aggregated map from 100 m to 250 m." width="100%" />
<p class="caption">
Figure 4.5: Original TWI vs aggregated map from 100 m to 250 m.
</p>
</div>
</div>
<div id="deriving-dem-parameters-using-saga-gis" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Deriving DEM parameters using SAGA GIS</h3>
<p>Now that we have established connection between R and SAGA GIS, we can also use SAGA GIS to derive some standard DEM parameters of interest to soil mapping. To automate further processing, we make the following function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">saga_DEM_derivatives &lt;-<span class="st"> </span><span class="cf">function</span>(INPUT, <span class="dt">MASK=</span><span class="ot">NULL</span>, <span class="dt">sel=</span><span class="kw">c</span>(<span class="st">&quot;SLP&quot;</span>,<span class="st">&quot;TWI&quot;</span>,<span class="st">&quot;CRV&quot;</span>,<span class="st">&quot;VBF&quot;</span>,<span class="st">&quot;VDP&quot;</span>,<span class="st">&quot;OPN&quot;</span>,<span class="st">&quot;DVM&quot;</span>)){
  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(MASK)){
    ## Fill in missing DEM pixels:
    <span class="kw">suppressWarnings</span>( <span class="kw">system</span>(<span class="kw">paste0</span>(saga_cmd, 
                                    <span class="st">&#39; grid_tools 25 -GRID=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, INPUT, 
                                    <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -MASK=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, MASK, <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -CLOSED=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                    INPUT, <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st">&#39;</span>)) )
  }
  ## Slope:
  <span class="cf">if</span>(<span class="kw">any</span>(sel <span class="op">%in%</span><span class="st"> &quot;SLP&quot;</span>)){
    <span class="kw">try</span>( <span class="kw">suppressWarnings</span>( <span class="kw">system</span>(<span class="kw">paste0</span>(saga_cmd, 
                                         <span class="st">&#39; ta_morphometry 0 -ELEVATION=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         INPUT, <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -SLOPE=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         <span class="kw">gsub</span>(<span class="st">&quot;.sgrd&quot;</span>, <span class="st">&quot;_slope.sgrd&quot;</span>, INPUT), 
                                         <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -C_PROF=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         <span class="kw">gsub</span>(<span class="st">&quot;.sgrd&quot;</span>, <span class="st">&quot;_cprof.sgrd&quot;</span>, INPUT), <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st">&#39;</span>) ) ) )
  }
  ## TWI:
  <span class="cf">if</span>(<span class="kw">any</span>(sel <span class="op">%in%</span><span class="st"> &quot;TWI&quot;</span>)){
    <span class="kw">try</span>( <span class="kw">suppressWarnings</span>( <span class="kw">system</span>(<span class="kw">paste0</span>(saga_cmd, 
                                         <span class="st">&#39; ta_hydrology 15 -DEM=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         INPUT, <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -TWI=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         <span class="kw">gsub</span>(<span class="st">&quot;.sgrd&quot;</span>, <span class="st">&quot;_twi.sgrd&quot;</span>, INPUT), <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st">&#39;</span>) ) ) )
  }
  ## MrVBF:
  <span class="cf">if</span>(<span class="kw">any</span>(sel <span class="op">%in%</span><span class="st"> &quot;VBF&quot;</span>)){
    <span class="kw">try</span>( <span class="kw">suppressWarnings</span>( <span class="kw">system</span>(<span class="kw">paste0</span>(saga_cmd, 
                                         <span class="st">&#39; ta_morphometry 8 -DEM=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         INPUT, <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -MRVBF=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>,
                                         <span class="kw">gsub</span>(<span class="st">&quot;.sgrd&quot;</span>, <span class="st">&quot;_vbf.sgrd&quot;</span>, INPUT),
                                         <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -T_SLOPE=10 -P_SLOPE=3&#39;</span>) ) ) )
  }
  ## Valley depth:
  <span class="cf">if</span>(<span class="kw">any</span>(sel <span class="op">%in%</span><span class="st"> &quot;VDP&quot;</span>)){
    <span class="kw">try</span>( <span class="kw">suppressWarnings</span>( <span class="kw">system</span>(<span class="kw">paste0</span>(saga_cmd, 
                                         <span class="st">&#39; ta_channels 7 -ELEVATION=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         INPUT, <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -VALLEY_DEPTH=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         <span class="kw">gsub</span>(<span class="st">&quot;.sgrd&quot;</span>, <span class="st">&quot;_vdepth.sgrd&quot;</span>, 
                                              INPUT), <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st">&#39;</span>) ) ) )
  }
  ## Openess:
  <span class="cf">if</span>(<span class="kw">any</span>(sel <span class="op">%in%</span><span class="st"> &quot;OPN&quot;</span>)){
    <span class="kw">try</span>( <span class="kw">suppressWarnings</span>( <span class="kw">system</span>(<span class="kw">paste0</span>(saga_cmd, 
                                         <span class="st">&#39; ta_lighting 5 -DEM=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         INPUT, <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -POS=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         <span class="kw">gsub</span>(<span class="st">&quot;.sgrd&quot;</span>, <span class="st">&quot;_openp.sgrd&quot;</span>, INPUT), 
                                         <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -NEG=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                         <span class="kw">gsub</span>(<span class="st">&quot;.sgrd&quot;</span>, <span class="st">&quot;_openn.sgrd&quot;</span>, INPUT), 
                                         <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -METHOD=0&#39;</span> ) ) ) )
  }
  ## Deviation from Mean Value:
  <span class="cf">if</span>(<span class="kw">any</span>(sel <span class="op">%in%</span><span class="st"> &quot;DVM&quot;</span>)){
    <span class="kw">suppressWarnings</span>( <span class="kw">system</span>(<span class="kw">paste0</span>(saga_cmd, 
                                    <span class="st">&#39; statistics_grid 1 -GRID=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                    INPUT, <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -DEVMEAN=</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
                                    <span class="kw">gsub</span>(<span class="st">&quot;.sgrd&quot;</span>, <span class="st">&quot;_devmean.sgrd&quot;</span>, INPUT), 
                                    <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st"> -RADIUS=11&#39;</span> ) ) )
  }
}</code></pre></div>
<p>To run this function we only need DEM as input:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">writeGDAL</span>(eberg_grid[<span class="st">&quot;DEMSRT6&quot;</span>], <span class="st">&quot;extdata/DEMSRT6.sdat&quot;</span>, <span class="st">&quot;SAGA&quot;</span>)
<span class="kw">saga_DEM_derivatives</span>(<span class="st">&quot;DEMSRT6.sgrd&quot;</span>)</code></pre></div>
<p>which derives all DEM derivatives at once:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dem.lst &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">pattern=</span><span class="kw">glob2rx</span>(<span class="st">&quot;^DEMSRT6_*.sdat&quot;</span>))
<span class="kw">plot</span>(<span class="kw">stack</span>(dem.lst), <span class="dt">col=</span>SAGA_pal[[<span class="dv">1</span>]])</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:dem-derivatives-plot"></span>
<img src="figures/dem_derivatives_plot.png" alt="Some standard DEM derivatives calculated using SAGA GIS." width="90%" />
<p class="caption">
Figure 4.6: Some standard DEM derivatives calculated using SAGA GIS.
</p>
</div>
<p>This function can now be used with any DEM to derive the standard 7-8 DEM parameters such as slope and curvature, TWI and MrVBF, positive and negative openess, valley depth and deviation from mean value. You could easily add more parameters to this function and then test if some of the other DEM derivatives can help improve mapping soil properties and classes. Note that SAGA GIS will by default optimize computing of DEM derivatives by using most of available cores to compute (parallelization is turned on automatically).</p>
</div>
<div id="deriving-dem-parameters-using-litap" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Deriving DEM parameters using LITAP</h3>
<p>To derive unique hydrological parameters that can potentially help soil mapping we can also use the LITAP (Landscape Integrated Terrain Analysis Package) package originally implemented as FlowMapR program <span class="citation">(MacMillan <a href="references.html#ref-macmillan2003landmapr">2003</a>)</span>, and compiled for R users by Stefanie LaZerte and Li Sheng from the Agriculture and Agri-Food Canada. We can install this package from github by using:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span>(<span class="op">!</span><span class="kw">require</span>(<span class="st">&quot;LITAP&quot;</span>)){ devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;steffilazerte/LITAP&quot;</span>) }</code></pre></div>
<p>A suite of hydrological flow DEM derivatives can be derived by using the generic command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(LITAP)
<span class="kw">library</span>(rgdal)
<span class="kw">writeGDAL</span>(eberg_grid[<span class="st">&quot;DEMSRT6&quot;</span>], <span class="st">&quot;extdata/DEMSRT6.tif&quot;</span>, <span class="dt">type=</span><span class="st">&quot;Int16&quot;</span>, <span class="dt">mvFlag=</span><span class="op">-</span><span class="dv">32768</span>)
LITAP<span class="op">::</span><span class="kw">complete_run</span>(<span class="dt">file =</span> <span class="st">&quot;extdata/DEMSRT6.tif&quot;</span>, <span class="dt">folder_out =</span> <span class="st">&quot;extdata/&quot;</span>, 
                    <span class="dt">report =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p>which will fill in derive number of hydrological parameters and that are maybe not available in other packages and that can be used to quantify soil deposition / accumulation processes. To plot for example watersheds by flow paths we can run:</p>
<div class="figure" style="text-align: center"><span id="fig:watersheds-by-flow-paths"></span>
<img src="Soil_covariates_files/figure-html/watersheds-by-flow-paths-1.png" alt="Watersheds by flow paths dervied using the [LITAP](https://steffilazerte.github.io/LITAP/) package." width="768" />
<p class="caption">
Figure 4.7: Watersheds by flow paths dervied using the <a href="https://steffilazerte.github.io/LITAP/">LITAP</a> package.
</p>
</div>
<p>Which shows all watersheds and individual streams derived using the filled DEM (after pit removal).</p>
</div>
<div id="filtering-out-missing-pixels-and-artifacts" class="section level3">
<h3><span class="header-section-number">4.2.5</span> Filtering out missing pixels and artifacts</h3>
<p>After we have brought all covariates to the same grid definition, what can still represent a problem for using covariates in spatial modelling are:</p>
<ul>
<li><p>Missing pixels,</p></li>
<li><p>Artifacts and noise,</p></li>
<li><p>Multicolinearity (i.e. data overlap),</p></li>
</ul>
<p>In a stack with tens of rasters, the <em>weakest layer</em> (i.e. the layer with highest number of missing pixels or highest amount of artifacts) could cause serious problems for producing soil maps as the missing pixels and artifacts would propagate to predictions: if only one layer in the raster stack misses values than predictive models might drop whole rows in the predictions even though data is available for 95% of rows. Missing pixels happen due to various reasons: in the case of remote sensing, missing pixels can be due to clouds or similar; noise is often due to atmospheric conditions. Missing pixels (as long as we are dealing with few patches of missing pixels) can be efficiently filtered by using for example the <a href="http://saga-gis.org/saga_module_doc/2.2.7/grid_tools_7.html">gap filling functionality</a> available in the SAGA GIS e.g.:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">image</span>(<span class="kw">raster</span>(eberg_grid[<span class="st">&quot;test&quot;</span>]), <span class="dt">col=</span>SAGA_pal[[<span class="dv">1</span>]], <span class="dt">zlim=</span>zlim, <span class="dt">main=</span><span class="st">&quot;Original&quot;</span>, <span class="dt">asp=</span><span class="dv">1</span>)
<span class="kw">image</span>(<span class="kw">raster</span>(<span class="st">&quot;test.sdat&quot;</span>), <span class="dt">col=</span>SAGA_pal[[<span class="dv">1</span>]], <span class="dt">zlim=</span>zlim, <span class="dt">main=</span><span class="st">&quot;Filtered&quot;</span>, <span class="dt">asp=</span><span class="dv">1</span>)</code></pre></div>
<p>In this example we use the same input and output file for filling in gaps. There are several other gap filling possibilities in SAGA GIS including Close Gaps with Spline, Close Gaps with Stepwise Resampling and Close One Cell Gaps. Note all of these are equally applicable to all missing pixel problems, but having &lt;10% of missing pixels is often not much of a problem for soil mapping.</p>
<p>Another elegant way to filter the missing pixels, reduce noise and reduce data overlap is to use <a href="http://www.rdocumentation.org/packages/stats/functions/prcomp">Principal Components</a> transformation of original data. This is available also via the GSIF function <a href="http://www.rdocumentation.org/packages/GSIF/functions/spc">‘’spc’’</a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(eberg_grid)
<span class="kw">gridded</span>(eberg_grid) &lt;-<span class="st"> </span><span class="er">~</span>x<span class="op">+</span>y
<span class="kw">proj4string</span>(eberg_grid) &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:31467&quot;</span>)
formulaString &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>PRMGEO6<span class="op">+</span>DEMSRT6<span class="op">+</span>TWISRT6<span class="op">+</span>TIRAST6
eberg_spc &lt;-<span class="st"> </span>GSIF<span class="op">::</span><span class="kw">spc</span>(eberg_grid, formulaString)
<span class="kw">names</span>(eberg_spc<span class="op">@</span>predicted) <span class="co"># 11 components on the end;</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:eberg-spc-11-plot"></span>
<img src="figures/eberg_spc_11_plot.png" alt="11 PCs derived using eberg covariates." width="100%" />
<p class="caption">
Figure 4.8: 11 PCs derived using eberg covariates.
</p>
</div>
<p>The advantages of using the <a href="http://www.rdocumentation.org/packages/GSIF/functions/spc">‘’spc’’</a> function are:</p>
<ul>
<li><p>All output soil covariates are numeric (and not a mixture of factors and numeric),</p></li>
<li><p>Last 1-2 PCs often contain signal noise and could be excluded from modelling,</p></li>
<li><p>In further analysis it becomes easier to remove covariates that do not help in modelling (e.g. by using step-wise selection and similar),</p></li>
</ul>
<p>A disadvantage of using SPCs (spatial predictive components) is that the components are often abstract so that interpretation of correlations can become cumbersome. Also, if one of the layers contains many factor levels, then the number of output covariates might blow up, which become impractical as we should then have at least 10 observations per covariate to avoid overfitting.</p>
</div>
<div id="overlaying-and-subsetting-raster-stacks-and-points" class="section level3">
<h3><span class="header-section-number">4.2.6</span> Overlaying and subsetting raster stacks and points</h3>
<p>Now that we have prepared all covariates (resampled them to the same grid and filtered out all problems), we can proceed with running overlays and fitting statistical models. Assuming that we deal with large number of files, an elegant way to read all those to R is by using the raster package, especially the <a href="http://www.rdocumentation.org/packages/raster/functions/stack">‘’stack’’</a> and <a href="http://www.rdocumentation.org/packages/raster/functions/stack">‘’raster’’</a> commands. In the following example we can list all files of interest, and then read them all at once:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(raster)
grd.lst &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">pattern=</span><span class="st">&quot;25m&quot;</span>)
grd.lst
grid25m &lt;-<span class="st"> </span><span class="kw">stack</span>(grd.lst)
grid25m &lt;-<span class="st"> </span><span class="kw">as</span>(grid25m, <span class="st">&quot;SpatialGridDataFrame&quot;</span>)
<span class="kw">str</span>(grid25m)</code></pre></div>
<p>One could now save a the prepared covariates stored in SpatialGridDataFrame as an RDS data object for future use.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(grid25m, <span class="dt">file =</span> <span class="st">&quot;extdata/covariates25m.rds&quot;</span>)</code></pre></div>
<p>To overlay rasters and points and prepare a regression matrix, we can either use the <a href="http://www.rdocumentation.org/packages/sp/functions/over"><code>over</code></a> function from the sp package, or <a href="http://www.rdocumentation.org/packages/raster/functions/extract"><code>extract</code></a> function from the raster package. By using raster package, one can run overlay even without reading the rasters to memory:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sp)
<span class="kw">data</span>(eberg)
<span class="kw">coordinates</span>(eberg) &lt;-<span class="st"> </span><span class="er">~</span>X<span class="op">+</span>Y
<span class="kw">proj4string</span>(eberg) &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:31467&quot;</span>)
ov =<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">extract</span>(<span class="kw">stack</span>(grd.lst), eberg))
<span class="kw">str</span>(ov[<span class="kw">complete.cases</span>(ov),])</code></pre></div>
<p>If the raster layers can not be stacked and if each layer is available in a different projection system, you can also create a function that reprojects points to the target raster layer projection system:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">overlay.fun =<span class="st"> </span><span class="cf">function</span>(i, y){
  raster<span class="op">::</span><span class="kw">extract</span>(<span class="kw">raster</span>(i), <span class="dt">na.rm=</span><span class="ot">FALSE</span>, 
      <span class="kw">spTransform</span>(y, <span class="kw">proj4string</span>(<span class="kw">raster</span>(i))))}</code></pre></div>
<p>which can also be run in parallel for example by using the parallel package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ov =<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">mclapply</span>(grd.lst, <span class="dt">FUN=</span>overlay.fun, <span class="dt">y=</span>eberg))
<span class="kw">names</span>(ov) =<span class="st"> </span><span class="kw">basename</span>(grd.lst)</code></pre></div>
<p>In similar way one could also make wrapper functions that downscale/upscale grids, then filter missing values and stack all data together so that it become available in the working memory (sp grid or pixels object). Overlay and model fitting is also implemented directly in the GSIF package, so any attempt to fit models will automatically perform overlay.</p>
</div>
<div id="working-with-larger-rasters" class="section level3">
<h3><span class="header-section-number">4.2.7</span> Working with large(r) rasters</h3>
<p>As R is often inefficient in handling large objects in memory (such as large raster images), a good strategy to run raster processing in R is to consider using for example the <code>clusterR</code> function from the <a href="https://cran.r-project.org/package=raster">raster</a> package, which automatically parallelizes use of raster functions. To have full control over parallelization, you can alternatively tile large rasters using the <code>getSpatialTiles</code> function from the GSIF package and process them as separate objects in parallel. The following examples shows how to run a simple function in parallel on tiles and then mosaic those after all processing has been completed. Consider for example the GeoTiff from the rgdal package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fn =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;pictures/SP27GTIF.TIF&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;rgdal&quot;</span>)
obj &lt;-<span class="st"> </span>rgdal<span class="op">::</span><span class="kw">GDALinfo</span>(fn)
<span class="co">#&gt; Warning: statistics not supported by this driver</span></code></pre></div>
<p>We can split that object in 35 tiles, each of 5 x 5 km in size by running:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tiles &lt;-<span class="st"> </span>GSIF<span class="op">::</span><span class="kw">getSpatialTiles</span>(obj, <span class="dt">block.x=</span><span class="dv">5000</span>, <span class="dt">return.SpatialPolygons =</span> <span class="ot">FALSE</span>)
tiles.pol &lt;-<span class="st"> </span>GSIF<span class="op">::</span><span class="kw">getSpatialTiles</span>(obj, <span class="dt">block.x=</span><span class="dv">5000</span>, <span class="dt">return.SpatialPolygons =</span> <span class="ot">TRUE</span>)
tile.pol  &lt;-<span class="st"> </span><span class="kw">SpatialPolygonsDataFrame</span>(tiles.pol, tiles)
<span class="kw">plot</span>(<span class="kw">raster</span>(fn), <span class="dt">col=</span><span class="kw">bpy.colors</span>(<span class="dv">20</span>))
<span class="kw">lines</span>(tile.pol, <span class="dt">lwd=</span><span class="dv">2</span>)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:rplot-large-raster-tiles"></span>
<img src="figures/rplot_large_raster_tiles.png" alt="Example of a tiling system derived using the `GSIF::getSpatialTiles` function." width="80%" />
<p class="caption">
Figure 4.9: Example of a tiling system derived using the <code>GSIF::getSpatialTiles</code> function.
</p>
</div>
<p>rgdal further allows us to read only a single tile of the GeoTiff by using the <code>offset</code> and <code>region.dim</code> arguments:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x =<span class="st"> </span><span class="kw">readGDAL</span>(fn, <span class="dt">offset=</span><span class="kw">unlist</span>(tiles[<span class="dv">1</span>,<span class="kw">c</span>(<span class="st">&quot;offset.y&quot;</span>,<span class="st">&quot;offset.x&quot;</span>)]),
             <span class="dt">region.dim=</span><span class="kw">unlist</span>(tiles[<span class="dv">1</span>,<span class="kw">c</span>(<span class="st">&quot;region.dim.y&quot;</span>,<span class="st">&quot;region.dim.x&quot;</span>)]),
             <span class="dt">output.dim=</span><span class="kw">unlist</span>(tiles[<span class="dv">1</span>,<span class="kw">c</span>(<span class="st">&quot;region.dim.y&quot;</span>,<span class="st">&quot;region.dim.x&quot;</span>)]), <span class="dt">silent =</span> <span class="ot">TRUE</span>)
<span class="kw">spplot</span>(x)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:sp27gtif-tile"></span>
<img src="figures/sp27gtif_tile.png" alt="A tile produced for a satellite image in the example above." width="60%" />
<p class="caption">
Figure 4.10: A tile produced for a satellite image in the example above.
</p>
</div>
<p>We would like to run a function on this raster in parallel, for example a simple function that converts values to 0/1 values based on a threshold:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fun_mask &lt;-<span class="st"> </span><span class="cf">function</span>(i, tiles, <span class="dt">dir=</span><span class="st">&quot;./tiled/&quot;</span>, <span class="dt">threshold=</span><span class="dv">190</span>){
  out.tif =<span class="st"> </span><span class="kw">paste0</span>(dir, <span class="st">&quot;T&quot;</span>, i, <span class="st">&quot;.tif&quot;</span>)
  <span class="cf">if</span>(<span class="op">!</span><span class="kw">file.exists</span>(out.tif)){
    x =<span class="st"> </span><span class="kw">readGDAL</span>(fn, <span class="dt">offset=</span><span class="kw">unlist</span>(tiles[i,<span class="kw">c</span>(<span class="st">&quot;offset.y&quot;</span>,<span class="st">&quot;offset.x&quot;</span>)]), <span class="dt">region.dim=</span><span class="kw">unlist</span>(tiles[i,<span class="kw">c</span>(<span class="st">&quot;region.dim.y&quot;</span>,<span class="st">&quot;region.dim.x&quot;</span>)]), <span class="dt">output.dim=</span><span class="kw">unlist</span>(tiles[i,<span class="kw">c</span>(<span class="st">&quot;region.dim.y&quot;</span>,<span class="st">&quot;region.dim.x&quot;</span>)]), <span class="dt">silent =</span> <span class="ot">TRUE</span>)
    x<span class="op">$</span>mask =<span class="st"> </span><span class="kw">ifelse</span>(x<span class="op">$</span>band1<span class="op">&gt;</span>threshold, <span class="dv">1</span>, <span class="dv">0</span>)
    <span class="kw">writeGDAL</span>(x[<span class="st">&quot;mask&quot;</span>], <span class="dt">type=</span><span class="st">&quot;Byte&quot;</span>, <span class="dt">mvFlag =</span> <span class="dv">255</span>, out.tif, <span class="dt">options=</span><span class="kw">c</span>(<span class="st">&quot;COMPRESS=DEFLATE&quot;</span>))
  }
}</code></pre></div>
<p>This can now be run through <code>mclapply</code> function from the parallel package (which automatically employs all available cores):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x0 &lt;-<span class="st"> </span><span class="kw">mclapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(tiles), <span class="dt">FUN=</span>fun_mask, <span class="dt">tiles=</span>tiles)</code></pre></div>
<p>We can look in the the tiles folder, and this should shows 35 produced GeoTiffs. These can be further used to construct a virtual mosaic by using:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t.lst &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path=</span><span class="st">&quot;extdata/tiled&quot;</span>, <span class="dt">pattern=</span><span class="kw">glob2rx</span>(<span class="st">&quot;^T*.tif$&quot;</span>), <span class="dt">full.names=</span><span class="ot">TRUE</span>, <span class="dt">recursive=</span><span class="ot">TRUE</span>)
<span class="kw">cat</span>(t.lst, <span class="dt">sep=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">file=</span><span class="st">&quot;SP27GTIF_tiles.txt&quot;</span>)
<span class="kw">system</span>(<span class="st">&#39;gdalbuildvrt -input_file_list SP27GTIF_tiles.txt SP27GTIF.vrt&#39;</span>)
<span class="kw">system</span>(<span class="st">&#39;gdalwarp SP27GTIF.vrt SP27GTIF_mask.tif -ot </span><span class="ch">\&quot;</span><span class="st">Byte</span><span class="ch">\&quot;</span><span class="st">&#39;</span>, 
  <span class="st">&#39; -dstnodata 255 -co </span><span class="ch">\&quot;</span><span class="st">BIGTIFF=YES</span><span class="ch">\&quot;</span><span class="st"> -r </span><span class="ch">\&quot;</span><span class="st">near</span><span class="ch">\&quot;</span><span class="st"> -overwrite -co </span><span class="ch">\&quot;</span><span class="st">COMPRESS=DEFLATE</span><span class="ch">\&quot;</span><span class="st">&#39;</span>)</code></pre></div>
<p>Note we use few important settings here for GDAL e.g. <code>-overwrite -co &quot;COMPRESS=DEFLATE&quot;</code> to overwrite the GeoTiff and internally compress it to save space and <code>-r &quot;near&quot;</code> basically no resampling just binding tiles together. Also, if the output GeoTiff is HUGE, you will most likely have to turn on <code>-co &quot;BIGTIFF=YES&quot;</code> otherwise gdalwarp would not run through. The output mosaic looks like this:</p>
<div class="figure" style="text-align: center"><span id="fig:sp27gtif-mask"></span>
<img src="figures/sp27gtif_mask.png" alt="Final processed output." width="80%" />
<p class="caption">
Figure 4.11: Final processed output.
</p>
</div>
<p>This shows that R can be used to compute with large rasters provided that these operations can be parallelized. Suggested best practice for this is to: (1) design a tiling system that optimizes use of RAM and read/write spead of a disk, (2) prepare and test a function that can be then run in parallel, and (3) stitch back all tiles to a large raster using <code>gdalwarp</code>. Note that Tiling and and stitching can not be applied universally to all problems e.g. functions that require global geographical search or all data in the raster, in which cases tiling should be applied with overlap (to minimize boundary effects) or to irregular tiling systems (e.g. per watershed). Once an optimal tiling system and function is prepared, R is not any more limit to running efficient computing, but only how much RAM and cores you have available i.e. it becomes more a hardware than a software problem.</p>
</div>
</div>
<div id="summary-points-1" class="section level2">
<h2><span class="header-section-number">4.3</span> Summary points</h2>
<p>Soil covariate layers are one of the key inputs to predictive soil mapping. Before any spatial layer can be used for modeling, it typically needs to be preprocessed to remove artifacts, resample to standard resolution, fill in the missing values etc. All these operations can be succesfully run by combining R and Open Source GIS software and by careful programming and optimization.</p>
<p>Preparing soil covariates can often be time and resources consuming so careful preparation and prioritisation of processing is highly recommended. <span class="citation">Hengl, Mendes de Jesus, et al. (<a href="references.html#ref-Hengl2017SoilGrids250m">2017</a>)</span> show that, for soil types and soil textures, DEM-parameters, i.e. soil forming factors of relief, especially flow-based DEM-indices, emerge as second-most dominant covariates. These results largely correspond with conventional soil survey knowledge (surveyors have been using relief as a key guideline to delineate soil bodies for decades).</p>
<p>Although lithology is not in the list of top 15 most important predictors, spatial patterns of lithologic classes can often be distinctly recognized in the output predictions. This is especially true for soil texture fractions and coarse fragments. In general, for predicting soil chemical properties, climatic variables (especially precipitation) and surface reflectance seem to be the most important, while for soil classes and soil physical properties it is a combination of relief, vegetation dynamics and parent material. Investing extra time in preparing a better map of soil parent material is often a good idea.</p>
<p>Other potentially useful covariates for predicting soil properties and classes could be maps of paleolithic i.e. pre-historic climatic conditions of soil formation, e.g. glacial landscapes and processes, past climate conditions and similar. These could likely become significant predictors of many current soil characteristics. Information on pre-historic climatic conditions and land use is unfortunately often not available, especially not at detailed cartographic scales, although there are now several global products that represent, for example, dynamics of land use / changes of land cover (see e.g. HYDE data set <span class="citation">(Klein Goldewijk et al. <a href="references.html#ref-klein2011hyde">2011</a>)</span>) through the past 1500+ years. As the spatial detail and completeness of such pre-historic maps increases, they will become potentially interesting covariates for global soil modeling.</p>
<p>USA’s NASA and USGS, with its MODIS, Landsat and similar civil-applications missions will likely remain the main source of spatial covariate data to support global and local soil mapping initiatives.</p>

</div>
</div>
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://https-envirometrix-github-io-predictivesoilmapping.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            </section>

          </div>
        </div>
      </div>
<a href="soil-variables-chapter.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="statistical-theory.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/envirometrix/PredictiveSoilMapping/edit/master/Soil_covariates.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
